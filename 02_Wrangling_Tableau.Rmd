# Tableau Toolbox

```{r, echo=FALSE, warning=FALSE, message=FALSE}
# Unattach any packages that happen to already be loaded. In general this is unecessary
# but is important for the creation of the book to not have package namespaces
# fighting unexpectedly.
pkgs = names(sessionInfo()$otherPkgs)
if( length(pkgs > 0)){
  pkgs = paste('package:', pkgs, sep = "")
  for( i in 1:length(pkgs)){
    detach(pkgs[i], character.only = TRUE, force=TRUE)
  }
}

library(tidyverse) # dplyr, tidyr, ggplot2, etc.

knitr::opts_chunk$set(echo = FALSE)

```

Tableau comes with two pieces of software, `Tableau Prep` and `Tableau`. The prep software is intended to support the data tidying, cleaning, and summarization steps. Then we save the result to a file and open the cleaned up data in Tableau to do the visualization. 

This course has access to both Tableau and Tableau Prep through an academic license. 

1. Go to [https://www.tableau.com/products/prep/download](https://www.tableau.com/products/prep/download) to download both products.
2. Select each product download link to get started. When prompted, enter your school email address for Business E-mail and enter the name of your school for Organization.
3. Activate with your product key which will be distributed via email or on Bblearn.

This license will work through the semester. You may continue using Tableau after the class is over by individually requesting their own one-year license through the [Tableau for Students](https://www.tableau.com/academic/students) program.

## Importing data
Often data will be stored in a Comma Separated Values file that has a `.csv` file suffix. These types of files store data tables, and use a comma to separate the columns. Spreadsheet programs will recognize these files and show columns for `Student Name`, `Exam 1`, `Exam 2` and the `Final Exam`. However, if you open these files using a text reader program, they'll look something like this:

```{r, eval=FALSE, echo=TRUE}
Student Name,Exam 1,Exam 2,Final Exam
Alice,87,87,81
Bob,91,88,85
Charlie,88,79,92
```

Below is a video showing how to open up this same data in Tableau Prep.

<iframe width="560" height="315" src="https://www.youtube.com/embed/ruWnLWGcwBI" frameborder="0" allowfullscreen></iframe>

The import step gives a rotated view of the data and generally that doesn't bother me, but for purposes of show what the imported data looks like, we'll add a cleaning step that doesn't do anything but will show the data. In general I won't keep this step in my cleaning workflow, but it is handy to know how to do this.

<iframe width="560" height="315" src="https://www.youtube.com/embed/f6KhNAlBNtU" frameborder="0" allowfullscreen></iframe>


## Tidying or Reshaping
Often source data is stored in a structure that isn't useful for subsequent analysis. When the data isn't a format of one observation per row and one variable per column, we need to fix those issues before proceeding.

### Gather
When data is in the *"wide"* format, we might need to convert it into *"long"* format. For an example, suppose we have a gradebook with a few students.

```{r}
grade.book <- rbind(
  tibble(Name='Alison', `Exam 1`=87, `Exam 2`=87, `Final Exam`=81),
  tibble(Name='Bob',    `Exam 1`=91, `Exam 2`=88, `Final Exam`=85),
  tibble(Name='Charlie',`Exam 1`=88, `Exam 2`=79, `Final Exam`=92))
grade.book
```

What we want to do is turn this data frame from a *wide* data frame into a *long* data frame. In MS Excel and Tableau, this is called pivoting. Essentially I'd like to create a data frame with three columns: `Name`, `Assessment`, and `Score`. That is to say that each homework datum really has three pieces of information: who it came from, which homework it was, and what the score was. It doesn't conceptually matter if I store it as 3 rows of 4 columns or 12 rows so long as there is a way to identify how a student scored on a particular homework. So we want to reshape the three Exam columns into just two columns (Assessment and Score). 

```{r}
# first we gather the score columns into columns we'll name Homework and Score
tidy.scores <- grade.book %>% 
  gather( key=Assessment,     # What should I call the key column
          value=Score,      # What should I call the values column
          `Exam 1`:`Final Exam`)        # which columns to apply this to
tidy.scores
```


<iframe width="560" height="315" src="https://www.youtube.com/embed/suCAb8qJOSM" frameborder="0" allowfullscreen></iframe>


### Spread
There are times that we need to convert a *"long"* dataset into *"wide"* format.  This is exactly the reverse function of the gather. Our example will be to undo the gather step from the previous. Again in Tableau, this is called pivoting, but we'll make sure that we are turning rows into columns.

The tricky part is what variable goes into which pivot field.  The top box specifies what the new column headers will be and the bottom box specifies what the cell values will be.

<iframe width="560" height="315" src="https://www.youtube.com/embed/qZ8L3KrAwnE" frameborder="0" allowfullscreen></iframe>


### Column Splitting
Sometimes we have columns where we actually have two pieces of information stored and we have to split the single column into multiple columns. 

For example, we might have data about across the country, where the city name obnoxiously includes the state.  It would be good to split the `Name` column into `City` and `State` columns. For example,

```{r}
cities <- tribble(
    ~Name, ~Population,
    'Phoenix, AZ', 1660272,
    'Flagstaff, AZ', 73964,
    'Tucson, AZ', 545975)
cities

write_csv(cities, 'data-raw/cities.csv')
```


<iframe width="560" height="315" src="https://www.youtube.com/embed/hrr_xYy8v-U" frameborder="0" allowfullscreen></iframe>


### New Column via Calculation

Often we need to take a column and create some sort of calculation. For example, if we are given some information (say student height) in inches, we might want to calculate their height in centimeters by multiplying each height value by $2.54$ and naming the result `Height (cm)`.

```{r}
data <- tribble(
  ~Grade, ~Gender, ~Height,
  '1st Grade', 'Male',   44,
  '1st Grade', 'Male',   42,
  '1st Grade', 'Female', 42,
  '1st Grade', 'Female', 40,
  '12th Grade', 'Male',   70,
  '12th Grade', 'Male',   68,
  '12th Grade', 'Male',   69,
  '12th Grade', 'Female', 64,
  '12th Grade', 'Female', 65)
data %>% mutate(`Height (cm)` = Height *2.54)
write_csv(data, 'data-raw/Group_Summarization.csv')
```

The issue in Tableau is to make sure you remember how to specify a column in a formula.  The syntax is `[column_name]` and then you can use that quantity in whatever formula you want.

<iframe width="560" height="315" src="https://www.youtube.com/embed/8YvXg1HEqdc" frameborder="0" allowfullscreen></iframe>

### Aggregation

Given a data set we also want to be able to calculate summary for various columns. For example, we might want to calculate the mean height for each grade level, or perhaps each gender within each grade level. Notice that we end up with a data set with *fewer rows*.

```{r}
data %>%
  group_by(Grade, Gender) %>%
  summarize(`Avg Height` = mean(Height))
```

<iframe width="560" height="315" src="https://www.youtube.com/embed/nMSppaAHTSM" frameborder="0" allowfullscreen></iframe>


### New Column with Aggregation
There are many cases where we need to create a calculated column, but the calculation involves 
some aggregated information. For, if have the number of males and females in each grade and we want to calculate the percentage of males and females in each grade.  To do this we need to aggregate data to count the number of students in each grade and then divide the number of males or females in each grade by the total number of students in the grade.

```{r}
data %>%
  group_by(Grade, Gender) %>%
  count(name = 'Grade_Gender_n')
```

```{r}
data %>%
  group_by(Grade, Gender) %>%
  count(name = 'Grade_Gender_n') %>%
  group_by(Grade) %>%
  mutate(Grade_n = sum(Grade_Gender_n)) %>%
  mutate(Proportion = Grade_Gender_n / Grade_n )
```

Anytime you need to include an aggregation value in formula, we need to specify any grouping information for calculating the aggregate. The code for this is to specify the grouping variable and the aggregation function and column. The code is: `{FIXED [Group]: SUM[Value]}`



<iframe width="560" height="315" src="https://www.youtube.com/embed/2USmtAcluEY" frameborder="0" allowfullscreen></iframe>

## Cleaning
### Column Types

In a data set, columns have types. They could be 

1. Character Strings
2. Categorical Groups (sometimes called factors)
3. Numerical Values
4. Geographical Locations
5. Dates and/or Times

During the data import step, the software will attempt to recognize character strings and numerical values, but most software packages have a hard time detecting categorical data as well as geographical and date/time data. You'll need to verify and correct the types before doing any analysis.





## Use Cases
### Filtering
### Summarization 
### Table Joins
### Table Unions
### Grouped Calculations

