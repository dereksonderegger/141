# Distributions

```{r, warning=FALSE, message=FALSE, echo=FALSE}
# Un-attach any packages that happen to already be loaded. In general this is unnecessary
# but is important for the creation of the book to not have package namespaces
# fighting unexpectedly.
pkgs = names(sessionInfo()$otherPkgs)
if( length(pkgs > 0)){
  pkgs = paste('package:', pkgs, sep = "")
  for( i in 1:length(pkgs)){
    detach(pkgs[i], character.only = TRUE, force=TRUE)
  }
}

# Chapter packages we will use
library(tidyverse)
library(ggridges)


# Don't show the R code!
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE)
```


Given a single variable, we often want to know what values are common and what values are rare. To visualize this, we will primarily compare marks along a common axis (the most accurate EPT). The only question is we have is how indicate how common particular values are.

### Small samples
If we only have a few observations, then we can just graph them along an axis. If we have too many data points, we'll have problems with over-plotting.

```{r, fig.height=1.5}
data('birthwt', package='MASS')
birthwt <- birthwt %>%
  mutate( smoke = ifelse( smoke==0, 'Non-smoker', 'Smoker' ) ) 

birthwt %>%
  slice(1:10) %>%
  ggplot(., aes(x=bwt)) +
  geom_point(aes(x=bwt), y=0) +
  labs( x='Birthweight (g)', y='', title='Strip plot: Infant Birthweight') +
  scale_y_continuous(breaks=NULL)
```

Another trick that works with more data, is to not use dots but rather lines. This is called a rugplot. The smaller width of the lines reduces, but don't completely mitigate, the overplotting issue.

```{r, fig.height=2}
birthwt %>%
  slice(1:10) %>%
  ggplot(., aes(x=bwt)) +
  geom_rug() +
  labs( x='Birthweight (g)', y='', title='Rug plot: Infant Birthweight')
```
A rugplot layer is often used in conjunction with another graph such as a scatterplot.


### Histograms
When we have a moderate size of data, graphing dots exactly on an axis doesn't work and results in overplotting and it is difficult to see where the data cluster. Instead we'll stack the dots in columns along the axis and call this a dotplot.

```{r}
birthwt %>%
  ggplot(., aes(x=bwt)) +
  geom_dotplot( dotsize=.7 ) +
  labs( x='Birthweight (g)', title='Dot plot: Infant Birthweight', y='') +
  scale_y_continuous(breaks=NULL)
```

Each dot represents an observation, but the x-values have been rounded into group values. So we have lost some precision. Another common version of this is a histogram, where the y-axis represents how many observations fall into each bin.

```{r}
birthwt %>% ggplot(., aes(x=bwt)) +
  geom_histogram( bins=30, color='black', fill='grey70' ) +
  labs( x='Birthweight (g)', title='Histogram: Infant Birthweight')
```

The choice of how many bins to include can make a dramatic difference in a graph. In particular, I don't believe that there is any biological reason to think the dip near 2700 grams is real. I believe that is is actually just an artifact of the data I have. Instead we should consider changing the number of bins.

```{r}
A <- birthwt %>% ggplot(., aes(x=bwt)) +
  geom_histogram( bins=30, color='black', fill='grey70' ) +
  labs( x='Birthweight (g)', title='Infant Birthweight') +
  geom_label(x=1200, y=15, label='bins = 30')
B <- birthwt %>% ggplot(., aes(x=bwt)) +
  geom_histogram( bins=14, color='black', fill='grey70' ) +
  labs( x='Birthweight (g)', title='Infant Birthweight')+
  geom_label(x=1000, y=30, label='bins = 14')
C <- birthwt %>% ggplot(., aes(x=bwt)) +
  geom_histogram( bins=9, color='black', fill='grey70' ) +
  labs( x='Birthweight (g)', title='Infant Birthweight')+
  geom_label(x=1000, y=45, label='bins = 9')
D <- birthwt %>% ggplot(., aes(x=bwt)) +
  geom_histogram( bins=4, color='black', fill='grey70' ) +
  labs( x='Birthweight (g)', title='Infant Birthweight')+
  geom_label(x=0, y=100, label='bins = 4')

cowplot::plot_grid(A,B,C,D)
```



### Density plots
Histograms suffer from being to angular or pointy. Another solution is call a kernel density smoother that mathematically smooths over the heights of the histogram bars.
```{r}
birthwt %>% ggplot(., aes(x=bwt, y=..density..)) +
  geom_histogram( bins=30, color='black', fill='grey70',  ) +
  geom_density(fill='cornsilk', alpha=.5) +
  labs( x='Birthweight (g)', title='Histogram + Density plots: Infant Birthweight') 
```


### Faceting
One of my favorite ways to display multiple distributions is to group each distribution into it's own plot in a process often referred to as faceting.

```{r}

A <- ggplot(birthwt, aes(x=bwt, fill=smoke)) +
  geom_density(position='stack') +
  labs( x='Birthweight (g)', title='Density plot: Infant Birthweight', y='') +
  scale_y_continuous(breaks=NULL) +
  facet_grid( . ~ smoke ) +
  theme( legend.position = 'None')
B <- ggplot(birthwt, aes(x=bwt, fill=smoke)) +
  geom_density(position='stack') +
  labs( x='Birthweight (g)', title='Density plot: Infant Birthweight', y='') +
  scale_y_continuous(breaks=NULL) +
  facet_grid( smoke ~ . )

cowplot::plot_grid(A,B, labels = c('A','B'))
```

By choosing to put the two graphs on top of the other, it becomes clear that the smoker's tend to give birth to smaller infants. This fact isn't clear in the side-by-side graphs.


### Stacking

Stacking the distribution involes laying each distribution on top of each other, so that the zero of the top curve follows the curve on the bottom. You can visualize the B chart having the Non-smoker density graph just melt onto the smoker density.

```{r}
ggplot(birthwt, aes(x=bwt, fill=smoke)) +
  geom_density(position='stack') +
  labs( x='Birthweight (g)', title='Stacked Density plots: Infant Birthweight', y='') +
  scale_y_continuous(breaks=NULL) 
```
I really don't like this graph because it is very hard to see where the peak of the non-smoker curve is. This stacking trick works well enough when we have proportions but isn't good here.



### Overlapping curves
Another option is to graph the densities, but allow them to overlap each other and be a bit see-thru.
```{r}
annotation.data <- data.frame(
  bwt=c(4500, 1500),
  y = c(5e-4, 5e-4),
  smoke = c('Non-smoker', 'Smoker'))
ggplot(birthwt, aes(x=bwt, fill=smoke)) +
  geom_density(position='identity', alpha=.5) +
  labs( x='Birthweight (g)', title='Overlaped Density plots: Infant Birthweight', y='') +
  scale_y_continuous(breaks=NULL) +
  geom_label( data=annotation.data, aes(y=y, label=smoke), alpha=.5) +
  theme(legend.position = 'None')
```

For seeing shifts in the center of the distribution, overlapping curves is quite powerful.


## Many distributions
Next we'll consider comparing many different distributions. In our example, we'll investigate the daily maximum temperature in Lincoln Nebraska in 2016 and we show the temperature distribution for each month. Therefore we'll have 12 different distributions to compare.


### Boxplots
Boxplots are a traditional way to display a distribution and the box contains the middle 50% of the data points.
```{r}
ggplot(lincoln_weather, aes(x=Month, y=`Max Temperature [F]`)) +
  geom_boxplot() +
  coord_flip() +
    labs(title = 'Box plots: Temperatures in Lincoln NE, 2016') 
```
While boxplots are quite commonly used, they summarize the data *too* much and a lot of interesting detail is lost in this summary.

### Ridge Plots
If we have a bunch of overlapping curves, but we stagger them along the y-axis, we get a type of graph called a *ridge graph*. 

```{r}
ggplot(lincoln_weather, aes(x = `Max Temperature [F]`, y = `Month`)) +
  geom_density_ridges_gradient(aes(fill = ..x..), scale = 3, size=.4, alpha=.2) +
  scale_fill_gradientn(colors=c('blue','purple','red'), values = c(0,.7, 1)) +
  # scale_fill_gradientn(
  #   colours = c("#0D0887FF", "#CC4678FF", "#F0F921FF"),
  #   name = "Temp. [F]")+
  labs(title = 'Ridge plot: Temperatures in Lincoln NE, 2016') 
```

Notice that in density plots, there were two peaks in December with the lower peak corresponding to a cold snap. That detail is lost in the boxplots.


### Violin Plots
An alternative to ridge plots a graph called a violin plot. This takes the density plots and mirrors them. Then we'll display them with no overlap in the different distributions. 

```{r, fig.height=4}
ggplot(lincoln_weather, aes(x=Month, y=`Max Temperature [F]`)) +
  geom_violin() +
  coord_flip() +
    labs(title = 'Violin plots: Temperatures in Lincoln NE, 2016') 

```
Now we can see the two peaks in December, but the three peaks in November have been flattened out because the amount of space necessary to show it would require that the densities overlap.

Ridgeline and violin plots are great alternatives to box plots and the choice to have the density plots overlap or not is up to the user.

