# Thinking Conditionally

```{r, echo=FALSE}
# Un-attach any packages that happen to already be loaded. In general this is unecessary
# but is important for the creation of the book to not have package namespaces
# fighting unexpectedly.
pkgs = names(sessionInfo()$otherPkgs)
if( length(pkgs > 0)){
  pkgs = paste('package:', pkgs, sep = "")
  for( i in 1:length(pkgs)){
    detach(pkgs[i], character.only = TRUE, force=TRUE)
  }
}
# Don't show the R code!
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message=FALSE)
```
```{r, warning=FALSE, message=FALSE}
# Chapter packages we will use
library(tidyverse)
```


There are many examples where the choice of grouping matters when looking at data sets.  In particular, Simpson's Paradox is a situation where the result changes based on what scale we examine the data.

## Examples

### Gender Bias in Admission Rates.

In 1975, researchers looked into alegations of gender bias in graduate program admissions at University of California, Berkeley. Data from 1973 admissions showed a statistically signficant difference between acceptance rates between males and females.

| Gender   |   Applicants    |  Percent Admitted |
|:--------:|:---------------:|:-----------------:|
| Males    |  8442           | 44%               |
| Females  |  4321           | 35%               |


This appears to be pretty convincing evidence that females are being discriminated against.  However... when we look closer at the data we should look at the department level admission rates.

| Gender   | Department |   Applicants    |  Percent Admitted |  Which is Higher? |
|:--------:|:----------:|:---------------:|:------------------|:------------:|
| Males   | A	| 825	| 62%	|   |
| Females | A | 108	| 82% | F |
| Males   | B	| 560	| 63%	|   |
| Females | B | 25	| 68% | F |
| Males   | C	| 325	| 37%	| M |
| Females | C | 593	| 34% |   |
| Males   | D	| 417	| 33%	|   | 
| Females | D | 375	| 35% | F |
| Males   | E	| 191	| 28%	| M |
| Females | E | 393	| 24% |   |
| Males   | F	| 373	| 6%	|   |
| Females | F | 341	| 7%  | F |

We first notice that males and females tended to apply to different programs. For example 88% of department A applicants were male. Because females tended to apply to departments with lower acceptance rates, they had a lower university wide acceptance rate. However, in most departments (6/8) they actually were accepted at a higher rate than males.

### Kidney Stone Treatment

Suppose that we have two different treatments to address Kidney Stones. 

| Treatment | Patients   | Success Percent |
|:---------:|:----------:|:--------------:|
|  A        |  273/350   |   78%          |	
|  B        |  289/350   |   83%          |

So it appears that treatment B is a superior treatment. But behind the scenes we have the issue that kidney stones come in different sizes and treatment A is commonly used to treat small stones, and treatment B is commonly used to treat large stones.

| Treatment |  Size      | Patients  | Success Percent |
|:---------:|:----------:|:---------:|:---------------:|
|  A        | Small      |  81/87    |   93%           |	
|  B        | Small      | 234/270   |   87%           |
|  A        | Large      | 192/263   |   73%           |	
|  B        | Large      |  55/80    |   69%           |

So treatment A is is the superior treatment in *both* the small and large kidney stone cases.  But because treatment A is actually more expensive, it is more commonly used in the large stone case.


```{r, warning=FALSE}
data <- tibble(Group = LETTERS[1:6], x.mean=seq(2,12,by=2), y.mean=seq(20,9,by=-2)) %>%
  mutate(Group = factor(Group)) %>%
  group_by(Group) %>%
  left_join(expand.grid(Group = LETTERS[1:6], rep=1:50), by='Group') %>%
  mutate( x = rnorm(n(), mean = x.mean, sd=2),
          y = y.mean + .5*x + rnorm(n(), mean = y.mean, sd=2) )
data %>% 
  ggplot( aes(x=x, y=y) ) +
  geom_point() +
  geom_smooth(method='lm') + 
  labs(x='Cause', y='Response', title='Without Considering Groups')
```

```{r}
data %>% 
  ggplot( aes(x=x, y=y, color=Group) ) +
  geom_point() +
  geom_smooth(method='lm') + 
  labs(x='Cause', y='Response', title='Considering Groups')
```
Without considering groups, there is a negative relationship between the cause/response, but when we consider the groups, there is a positive relationship.

### Build your own 

Simpson's paradox appears in a variety of situations. Come up with a scenario where the statistic changes interpretation based on the scale.

  1. Suppose that we look at patient fatalities between two surgeons. One surgeon is pretty average, while the other gets assigned the most dangerous and sever cases.
  2. Consider two baseball players where one players batting percentage is higher each year, but overall is lower.